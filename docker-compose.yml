version: '3.9'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - QUEUE_PROVIDER=${QUEUE_PROVIDER}
      - SQS_ENDPOINT=${SQS_ENDPOINT}
      - SQS_REGION=${SQS_REGION}
      - SQS_QUEUE_URL=${SQS_QUEUE_URL}
      - RABBITMQ_URL=${RABBITMQ_URL}
      - RABBITMQ_QUEUE=${RABBITMQ_QUEUE}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    depends_on:
      - localstack

  localstack:
    image: localstack/localstack
    ports:
      - "4566:4566"
      - "4571:4571"
    environment:
      - SERVICES=sqs
      - DEBUG=1
    volumes:
      - ./init-localstack.sh:/etc/localstack/init/ready.d/init-localstack.sh

  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "15672:15672"
      - "5672:5672"
    environment:
      RABBITMQ_DEFAULT_USER: guest
      RABBITMQ_DEFAULT_PASS: guest
    healthcheck:
      test: ["CMD-SHELL", "rabbitmqctl status"]
      interval: 10s
      timeout: 5s
      retries: 5
